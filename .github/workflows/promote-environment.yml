# =============================================================================
# PROMOTE ENVIRONMENT
# =============================================================================
# Promote image tags từ environment này sang environment khác
# Ví dụ: dev → staging, staging → production
# =============================================================================

name: Promote Environment

on:
  workflow_dispatch:
    inputs:
      source:
        description: 'Source environment'
        required: true
        type: choice
        options: [dev, staging]
      target:
        description: 'Target environment'
        required: true
        type: choice
        options: [staging, production]

jobs:
  validate:
    name: Validate Promotion
    runs-on: ubuntu-latest
    outputs:
      valid: ${{ steps.check.outputs.valid }}
    steps:
      - name: Validate promotion path
        id: check
        run: |
          SOURCE="${{ inputs.source }}"
          TARGET="${{ inputs.target }}"

          # Valid promotion paths: dev → staging, staging → production
          if [ "$SOURCE" == "dev" ] && [ "$TARGET" == "staging" ]; then
            echo "valid=true" >> $GITHUB_OUTPUT
          elif [ "$SOURCE" == "staging" ] && [ "$TARGET" == "production" ]; then
            echo "valid=true" >> $GITHUB_OUTPUT
          else
            echo "❌ Invalid promotion path: $SOURCE → $TARGET"
            echo "valid=false" >> $GITHUB_OUTPUT
            exit 1
          fi

  promote:
    name: Promote ${{ inputs.source }} → ${{ inputs.target }}
    runs-on: ubuntu-latest
    needs: validate
    # Production promotion requires approval
    environment: ${{ inputs.target == 'production' && 'production-approval' || 'default' }}

    steps:
      - uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Install yq
        run: |
          sudo wget -qO /usr/local/bin/yq https://github.com/mikefarah/yq/releases/latest/download/yq_linux_amd64
          sudo chmod +x /usr/local/bin/yq

      - name: Copy image tags from source to target
        run: |
          SOURCE="environments/${{ inputs.source }}/values.yaml"
          TARGET="environments/${{ inputs.target }}/values.yaml"

          echo "Promoting image tags: ${{ inputs.source }} → ${{ inputs.target }}"

          # Copy image tags for each service
          for KEY in gateway auth video interaction notification; do
            REPO=$(yq ".services.${KEY}.image.repository" "$SOURCE")
            TAG=$(yq ".services.${KEY}.image.tag" "$SOURCE")

            echo "  ${KEY}: ${REPO}:${TAG}"

            yq -i ".services.${KEY}.image.repository = \"${REPO}\"" "$TARGET"
            yq -i ".services.${KEY}.image.tag = \"${TAG}\"" "$TARGET"
          done

      - name: Commit and push
        run: |
          git config user.email "gitops-bot@tiktok-clone.local"
          git config user.name "GitOps Bot"
          git add environments/
          git commit -m "promote(${{ inputs.target }}): from ${{ inputs.source }}

          Promoted by: ${{ github.actor }}"
          git push

      - name: Summary
        run: |
          echo "## Promotion Complete" >> $GITHUB_STEP_SUMMARY
          echo "**${{ inputs.source }}** → **${{ inputs.target }}**" >> $GITHUB_STEP_SUMMARY
          echo "ArgoCD sẽ tự động sync thay đổi này lên K8s cluster" >> $GITHUB_STEP_SUMMARY
